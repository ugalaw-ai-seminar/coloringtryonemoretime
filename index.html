<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cozy Coloring Studio - AI Palette Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    body { margin: 0; background-color: #fffaf5; font-family: sans-serif; }
    canvas { border-radius: 16px; cursor: crosshair; touch-action: none; background: white; }
    .color-swatch { transition: transform 0.1s; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .color-swatch:hover { transform: scale(1.1); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    
    // Icon Component for Lucide
    const Icon = ({ name, size = 20, className = "" }) => {
      const iconRef = useRef(null);
      useEffect(() => {
        if (iconRef.current && lucide.icons[name]) {
          iconRef.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          icon.setAttribute('width', size);
          icon.setAttribute('height', size);
          iconRef.current.appendChild(icon);
        }
      }, [name, size]);
      return <span ref={iconRef} className={className} style={{display: 'inline-flex'}} />;
    };

    const CozyApp = () => {
      const canvasRef = useRef(null);
      const [ctx, setCtx] = useState(null);
      const [mode, setMode] = useState('fill');
      const [currentColor, setCurrentColor] = useState('#FF6B9D');
      const [isDrawing, setIsDrawing] = useState(false);
      const [history, setHistory] = useState([]);
      
      // AI States
      const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
      const [palettePrompt, setPalettePrompt] = useState('');
      const [suggestedColors, setSuggestedColors] = useState(['#FF6B9D', '#4ECDC4', '#FFD93D', '#1A535C', '#F7FFF7']);
      const [isAiLoading, setIsAiLoading] = useState(false);

      useEffect(() => {
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d', { willReadFrequently: true });
        setCtx(context);
        
        // Initial blank page
        context.fillStyle = 'white';
        context.fillRect(0, 0, 800, 800);
        
        // Add a sample border/line for testing fill
        context.strokeStyle = 'black';
        context.lineWidth = 5;
        context.strokeRect(100, 100, 600, 600);
        context.beginPath();
        context.moveTo(100, 100);
        context.lineTo(700, 700);
        context.stroke();

        setHistory([context.getImageData(0, 0, 800, 800)]);
      }, []);

      const saveToHistory = () => {
        setHistory(prev => [...prev.slice(-19), ctx.getImageData(0, 0, 800, 800)]);
      };

      const undo = () => {
        if (history.length <= 1) return;
        const newHistory = [...history];
        newHistory.pop();
        ctx.putImageData(newHistory[newHistory.length - 1], 0, 0);
        setHistory(newHistory);
      };

      // AI COLOR SUGGESTION LOGIC
      const fetchPalette = async () => {
        if (!palettePrompt.trim() || isAiLoading) return;
        if (!apiKey) { alert("Please enter an API key first."); return; }
        
        setIsAiLoading(true);
        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ 
                parts: [{ text: `Act as a professional color theorist. Provide a color palette of exactly 6 hex codes based on the theme: "${palettePrompt}". Return ONLY a JSON array of hex strings like ["#HEX1", "#HEX2", ...]. No text explanation.` }] 
              }],
              generationConfig: { response_mime_type: "application/json" }
            })
          });
          
          const data = await response.json();
          const colors = JSON.parse(data.candidates[0].content.parts[0].text);
          if (Array.isArray(colors)) {
            setSuggestedColors(colors);
            setCurrentColor(colors[0]);
          }
        } catch (err) {
          console.error("AI Error:", err);
          alert("Failed to get colors. Check your API key or prompt.");
        } finally {
          setIsAiLoading(false);
        }
      };

      // Tool Logic
      const handleCanvasAction = (e) => {
        const rect = canvasRef.current.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * (800 / rect.width));
        const y = Math.floor((e.clientY - rect.top) * (800 / rect.height));

        if (mode === 'fill') {
          floodFill(x, y);
        }
      };

      const floodFill = (x, y) => {
        const imgData = ctx.getImageData(0, 0, 800, 800);
        const data = imgData.data;
        const targetIdx = (y * 800 + x) * 4;
        const targetR = data[targetIdx], targetG = data[targetIdx+1], targetB = data[targetIdx+2];

        // Don't fill black lines (threshold)
        if (targetR < 50 && targetG < 50 && targetB < 50) return;

        const hexToRgb = (hex) => {
          const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
          return { r, g, b };
        };
        const fill = hexToRgb(currentColor);
        if (targetR === fill.r && targetG === fill.g && targetB === fill.b) return;

        const stack = [[x, y]];
        while (stack.length) {
          const [cx, cy] = stack.pop();
          const idx = (cy * 800 + cx) * 4;
          if (cx < 0 || cx >= 800 || cy < 0 || cy >= 800) continue;
          if (data[idx] === targetR && data[idx+1] === targetG && data[idx+2] === targetB) {
            data[idx] = fill.r; data[idx+1] = fill.g; data[idx+2] = fill.b; data[idx+3] = 255;
            stack.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
          }
        }
        ctx.putImageData(imgData, 0, 0);
        saveToHistory();
      };

      return (
        <div className="min-h-screen p-4 md:p-8 flex flex-col items-center">
          <div className="max-w-6xl w-full grid lg:grid-cols-[1fr,350px] gap-8">
            
            {/* Left side: Studio */}
            <div className="space-y-4">
              <div className="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex justify-between items-center">
                <h1 className="text-xl font-bold text-orange-600 flex items-center gap-2">
                  <Icon name="Palette" /> Cozy Studio
                </h1>
                <div className="flex gap-2">
                  <button onClick={undo} className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200"><Icon name="Undo2" /></button>
                  <button onClick={() => { ctx.fillStyle='white'; ctx.fillRect(0,0,800,800); saveToHistory(); }} className="p-2 bg-gray-100 rounded-lg text-red-500"><Icon name="Trash2" /></button>
                </div>
              </div>

              <div className="bg-white p-2 rounded-3xl shadow-xl border-4 border-orange-200 aspect-square overflow-hidden">
                <canvas ref={canvasRef} width={800} height={800} className="w-full h-full" onClick={handleCanvasAction} />
              </div>
              <p className="text-center text-orange-400 text-sm font-medium">Click any area to fill with your selected color!</p>
            </div>

            {/* Right side: AI Palette Tool */}
            <div className="space-y-6">
              <div className="bg-white p-6 rounded-3xl shadow-lg border-2 border-purple-100">
                <div className="flex items-center gap-2 mb-4 text-purple-700">
                  <Icon name="Sparkles" />
                  <h2 className="font-bold">AI Palette Agent</h2>
                </div>
                
                <label className="block text-[10px] uppercase font-bold text-gray-400 mb-1">Gemini API Key</label>
                <input 
                  type="password" 
                  className="w-full p-2 mb-4 border rounded-xl text-sm outline-none focus:border-purple-400"
                  placeholder="Paste Key Here..."
                  value={apiKey}
                  onChange={(e) => { setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value); }}
                />

                <label className="block text-[10px] uppercase font-bold text-gray-400 mb-1">Color Theme</label>
                <textarea 
                  className="w-full p-3 border rounded-2xl text-sm h-24 mb-4 resize-none outline-none focus:border-purple-400"
                  placeholder="Describe a mood or place (e.g. 'Rainy day in Tokyo' or 'Vibrant summer citrus')"
                  value={palettePrompt}
                  onChange={(e) => setPalettePrompt(e.target.value)}
                />

                <button 
                  onClick={fetchPalette}
                  disabled={isAiLoading}
                  className="w-full py-3 bg-purple-600 text-white rounded-2xl font-bold hover:bg-purple-700 transition disabled:bg-purple-200"
                >
                  {isAiLoading ? "Asking AI..." : "Get Suggested Palette"}
                </button>

                {/* The Suggested Colors */}
                <div className="mt-6">
                  <p className="text-xs font-bold text-gray-500 mb-3 text-center uppercase tracking-widest">Selected Palette</p>
                  <div className="grid grid-cols-3 gap-3">
                    {suggestedColors.map((color, idx) => (
                      <button 
                        key={idx}
                        onClick={() => setCurrentColor(color)}
                        className={`aspect-square rounded-2xl color-swatch ${currentColor === color ? 'ring-4 ring-purple-400 ring-offset-2' : ''}`}
                        style={{ backgroundColor: color }}
                        title={color}
                      />
                    ))}
                  </div>
                </div>
              </div>

              {/* Quick Info */}
              <div className="bg-orange-50 p-4 rounded-2xl border border-orange-100 text-xs text-orange-700">
                <p><strong>Tip:</strong> The AI understands feelings too! Try descriptions like "Melancholy" or "Joyful Energy" to get different color vibes.</p>
              </div>
            </div>

          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CozyApp />);
  </script>
</body>
</html>
